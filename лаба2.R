# –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞ 2: GARCH(p, q)
# 1. –ü–æ—Å—Ç—Ä–æ–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫ —Å—Ç–∞—Ü–∏–æ–Ω–∞—Ä–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ {‚Ñéùëõ} –∏ –≥—Ä–∞—Ñ–∏–∫ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏ 
# {ùúéùëõ} –ø—Ä–æ—Ü–µ—Å—Å–∞ GARCH(1,0), –∏–∑ ùëõ = 1000 –Ω–∞–±–ª—é–¥–µ–Ω–∏–π.

n = 1000
a0 = 0.7
a1 = 0.2

GARCH = function(a0, a1, n) # —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞ GARCH(1, 0)
{
  eps = rnorm(n, 0, 1) # –°–ª—É—á–∞–π–Ω—ã–µ –æ—à–∏–±–∫–∏
  sigma = numeric(n) # –í–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å
  h = numeric(n)
  # –ù–∞—á–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
  sigma[1] = 1
  h[1] = 0
  
  # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞
  for (i in 2:n) {
    sigma[i] = a0 + a1*(h[i-1])^2
    h[i] = sqrt(sigma[i])*eps[i]
  }
  
  # –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–æ–≤
  plot(h, type = "l", main = "–ì—Ä–∞—Ñ–∏–∫ —Å—Ç–∞—Ü–∏–æ–Ω–∞—Ä–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ GARCH(1,0)",
       xlab = "–ù–∞–±–ª—é–¥–µ–Ω–∏—è", ylab = "h", col = "blue", lwd = 2)
  plot(sigma, type = "l", main = "–ì—Ä–∞—Ñ–∏–∫ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞ GARCH(1,0)",
       xlab = "–ù–∞–±–ª—é–¥–µ–Ω–∏—è", ylab = "œÉ", col = "red", lwd = 2)
  h
}

h = GARCH(a0,a1,n)

# 2. –û—Ü–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã a0 –∏ a1 —Å –ø–æ–º–æ—â—å—é –º–µ—Ç–æ–¥–∞ –Ω–∞–∏–º–µ–Ω—å—à–∏—Ö –∫–≤–∞–¥—Ä–∞—Ç–æ–≤ (–ú–ù–ö), –ø—É—Ç–µ–º  
# –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞ ARCH(1) ‚â° GARCH(1,0) –∫ –ø—Ä–æ—Ü–µ—Å—Å—É –∞–≤—Ç–æ—Ä–µ–≥—Ä–µ—Å—Å–∏–∏ –ø–µ—Ä–≤–æ–≥–æ –ø–æ—Ä—è–¥–∫–∞. ???

MNK_a1 = function(h) # –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ú–ù–ö –æ—Ü–µ–Ω–∫–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ a1
{
  a = b = c = d = 0
  for (i in 2 : n) 
  { # –ù–∞—Ö–æ–∂–¥–µ–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —Ñ–æ—Ä–º—É–ª—ã
    a = a + h[i-1]^2
    b = b + h[i]^2
    c = c + h[i-1]^4
    d = d + h[i-1]^2 * h[i]^2
  }
  num = (d/n) - (a*b/(n^2))
  denum = (c/n) - (a/n)^2
  return (num/denum) # —Ñ–æ—Ä–º—É–ª–∞ –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –∞1
}

mnk_est_a1 = MNK_a1(h)
mnk_est_a1

MNK_a0 = function(h, a)  # –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ú–ù–ö –æ—Ü–µ–Ω–∫–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ a0
{
  x = y = 0
  for (i in 2 : n) 
  { # –ù–∞—Ö–æ–∂–¥–µ–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —Ñ–æ—Ä–º—É–ª—ã
    x = x + h[i-1]^2
    y = y + h[i]^2
  }
  return ((y/n) - (a*x/n)) # —Ñ–æ—Ä–º—É–ª–∞ –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –∞0
}

mnk_est_a0 = MNK_a0(h, mnk_est_a1) # –≤ —Ä–∞—Å—á–µ—Ç –ú–ù–ö –æ—Ü–µ–Ω–∫–∏ –¥–ª—è –∞0 –ø–µ—Ä–µ–¥–∞–µ–º –º–Ω–∫ –æ—Ü–µ–Ω–∫—É –∞1
mnk_est_a0

# 3. –û—Ü–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã a0, a1 –ø—Ä–∏ –ø–æ–º–æ—â–∏ —Ñ—É–Ω–∫—Ü–∏–∏ garch() –ø–∞–∫–µ—Ç–∞ tseries –ø–æ –≤—ã–±–æ—Ä–∫–µ {‚Ñéùëõ}.
install.packages("tseries")
library("tseries")

garch(h, order = c(0, 1), start = c(a0, a1))

# 4. –ü–æ—Å—Ç—Ä–æ–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫ —Å—Ç–∞—Ü–∏–æ–Ω–∞—Ä–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ GARCH(3,0), –∏–∑ ùëõ = 1100 –Ω–∞–±–ª—é–¥–µ–Ω–∏–π. 
# –†–∞–∑–¥–µ–ª–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å –Ω–∞ –æ–±—É—á–∞—é—â—É—é –∏ —Ç–µ—Å—Ç–æ–≤—É—é –≤—ã–±–æ—Ä–∫–∏ –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏–∏ 10:1. 
# –û—Ü–µ–Ω–∏—Ç—å –≤–µ–∫—Ç–æ—Ä –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ (ùëé0, ùëé1, ùëé2, ùëé3)‚Ä≤ –Ω–∞ –æ–±—É—á–∞—é—â–µ–π –≤—ã–±–æ—Ä–∫–µ, –∏—Å–ø–æ–ª—å–∑—É—è 
# —Ñ—É–Ω–∫—Ü–∏—é garch(). –ó–∞—Ç–µ–º –≤—ã—á–∏—Å–ª–∏—Ç—å –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø—Ä–æ–≥–Ω–æ–∑–æ–≤ –Ω–∞ 1 —à–∞–≥ {‚Ñéùëõ+1|ùëõ} 
# –Ω–∞ —Ç–µ—Å—Ç–æ–≤–æ–π –≤—ã–±–æ—Ä–∫–µ –∏ –Ω–∞–ª–æ–∂–∏—Ç—å –ø—Ä–æ–≥–Ω–æ–∑—ã –Ω–∞ –≥—Ä–∞—Ñ–∏–∫ –ø—Ä–æ—Ü–µ—Å—Å–∞.

n = 1100
a = c(0.2, 0.1, 0.4, 0.3) # –í–µ–∫—Ç–æ—Ä –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∞

GARCH_30 = function(n,a)
{
  eps = rnorm(n, 0, 1) # –°–ª—É—á–∞–π–Ω—ã–µ –æ—à–∏–±–∫–∏
  sigma = numeric(n) # –í–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å
  h = numeric(n) # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º—ã–π –ø—Ä–æ—Ü–µ—Å—Å
  
  # –ù–∞—á–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
  h[1] = 0
  sigma[2] = a[1]
  h[2] = sqrt(sigma[2]) * eps[1]
  sigma[3] = a[1] + a[2] * (h[2]^2) + a[3] * (h[1]^2)
  h[3] = sqrt(sigma[3]) * eps[2]
  
  # –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –¥–ª—è –≤—Å–µ—Ö –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –∑–Ω–∞—á–µ–Ω–∏–π
  for (i in 4:n) {
    sigma[i] = a[1] + a[2] * (h[i - 1]^2) + a[3] * (h[i - 2]^2) + a[4] * (h[i - 3]^2)
    h[i] = sqrt(sigma[i]) * eps[i - 1]
  }
  return(h) 
}

h1 = GARCH_30(n,a)
plot(h1, type = 'l', main = "–ì—Ä–∞—Ñ–∏–∫ —Å—Ç–∞—Ü–∏–æ–Ω–∞—Ä–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ GARCH(3,0)")

# –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞ –Ω–∞ –æ–±—É—á–∞—é—â—É—é –∏ —Ç–µ—Å—Ç–æ–≤—É—é –≤—ã–±–æ—Ä–∫–∏ –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏–∏ 10:1.
n = 1100
n1 = 1000 # 1000 –∫ 100

h_train = h1[1 : n1] # –û–±—É—á–∞—é—â–∞—è –≤—ã–±–æ—Ä–∫–∞ (1:1000)
h_test = h1[(n1+1) : n] # –¢–µ—Å—Ç–æ–≤–∞—è –≤—ã–±–æ—Ä–∫–∞ (1001:1100)

g = garch(h_train, order = c(0, 3), start = a); g # –û—Ü–µ–Ω–∫–∞ –≤–µ–∫—Ç–æ—Ä–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∞ –Ω–∞ –æ–±—É—á–∞—é—â–µ–π –≤—ã–±–æ—Ä–∫–µ
aa = g$coef 

# –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø—Ä–æ–≥–Ω–æ–∑–æ–≤ –Ω–∞ 1 —à–∞–≥ {‚Ñéùëõ+1|ùëõ} –Ω–∞ —Ç–µ—Å—Ç–æ–≤–æ–π –≤—ã–±–æ—Ä–∫–µ
prediction = function(h_test, h_train, a) 
{
  h = numeric(100) # –≤–µ–∫—Ç–æ—Ä —Å–æ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ—Å—Ç–æ–≤–æ–π –≤—ã–±–æ—Ä–∫–∏
  hh = numeric(1100) # –≤–µ–∫—Ç–æ—Ä-—Ä–µ–∑—É–ª—å—Ç–∞—Ç
  
  # –ù–∞—á–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
  h[1] = a[1]
  h[2] = a[1] + a[2]*(h_test[1]^2)
  h[3] = a[1] + a[2]*(h_test[2]^2) + a[3]*(h_test[1]^2)
  
  #–û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª
  for(i in 4 : 100) 
  {
    h[i] = a[1] + a[2]*(h_test[i-1]^2) + a[3]*(h_test[i-2]^2) + a[4]*(h_test[i-3]^2)
  }
  
  for(i in 1 : 1000) # –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –æ—Ç 1 –¥–æ 1000 –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –∏–∑ –æ–±—É—á–∞—é—â–µ–π –≤—ã–±–æ—Ä–∫–∏
  {
    hh[i] = h_train[i] 
  }
  for(i in 1001 : 1100)
  {
    hh[i] = h[i - 1000] # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ–º—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
  }
  hh
}

h2 = prediction(h_test, h_train, aa)
lines(h2, type = 'l', col = "lightseagreen") # –ù–∞–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–æ–≥–Ω–æ–∑–æ–≤ –Ω–∞ –≥—Ä–∞—Ñ–∏–∫ –ø—Ä–æ—Ü–µ—Å—Å–∞ 

# 5. –ü–æ—Å—Ç—Ä–æ–∏—Ç—å —Å—Ç–∞—Ü–∏–æ–Ω–∞—Ä–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å GARCH(1,1), –∏–∑ ùëõ = 1000 –Ω–∞–±–ª—é–¥–µ–Ω–∏–π –∏ 
# –æ—Ü–µ–Ω–∏—Ç—å –µ–≥–æ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (a0,a1,b1)‚Ä≤ –ø–æ –≤—ã–±–æ—Ä–∫–µ {‚Ñéùëõ}, –∏—Å–ø–æ–ª—å–∑—É—è —Ñ—É–Ω–∫—Ü–∏—é garch().

n = 1000
# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã
a0 = 0.2 
a1 = 0.1
b1 = 0.6

GARCH_11 = function(n, a0, a1, b1) 
{
  h = numeric(n)
  sigma = numeric(n)
  eps = rnorm(n, 0, 1)
  
  # –ù–∞—á–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
  h[1] = 1
  sigma[1] = 1  # –°—Ç–∞—Ü–∏–æ–Ω–∞—Ä–Ω–æ–µ –Ω–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
  
  # –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª
  for (i in 2 : n) 
  {
    sigma[i] = a0 + a1*(h[i-1])^2 + b1*sigma[i-1]
    h[i] = sqrt(sigma[i])*eps[i]
  }
  return(h)
}

h3 = GARCH_11(n, a0, a1, b1)
garch(h3, order = c(1, 1), start = c(a0, a1, b1)) # –æ—Ü–µ–Ω–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø—Ä–æ—Ü–µ—Å—Å–∞ GARCH(1,1)

